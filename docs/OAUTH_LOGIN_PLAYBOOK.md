# OAuthログイン自動化プレイブック

更新日: 2026-02-27

目的:
- 映画.com同期で発生したログイン失敗の原因と、最終的に安定動作した実装パターンを記録する。
- 他サービスのOAuthログイン自動化でも再利用できる判断軸を残す。

## 1. 起きた失敗と原因

1. `映画.com IDでのログインに失敗しました。` アラートが継続発生
- 原因: `/authorize/done` の戻りURLが `code` のみで `state` が欠落したまま遷移していた。
- 原因: `state` を自前生成して認可URLに付与する実装は、サーバ側に保持された状態と不一致になり失敗した。

2. 認可導線の誤クリック
- 原因: セレクタが広すぎて、OAuth導線ではない `https://id.eiga.com/info/lp/` を拾っていた。

3. セッションが不安定化 (`unexpected alert open`, `no such window`)
- 原因: `/login/oauth/gid` 直叩きの繰り返しや、アラート未処理のまま次操作へ進んでいた。

4. ログイン後に別ユーザーIDを誤取得
- 原因: ページ全体の `/user/...` を広く抽出し、ノイズリンクを拾っていた。

## 2. 成功に至った実装パターン

1. 開始導線を「実ページ導線優先」に固定
- `/login/` 上の実リンク・実ボタンからOAuthを開始する。
- 誤導線 (`/info/lp`) は除外する。

2. `state` の扱いを厳密化
- `state` は `current_url` / `referrer` / DOMリンクから回収する。
- `code` しかないコールバックURLでは、取得済み `state` を補完してから戻る。
- `state` を自前生成して開始しない。

3. `/authorize/done` は「戻るリンククリック」を基本動作にする
- `div.row.link_btn a.univLink` を優先。
- クリック前に実 `href` をログ出力し、必要なら `code+state` に整形してクリック。

4. アラート/ウィンドウ例外を先に処理
- `unexpected alert open` は即受理して状態を再評価。
- ウィンドウ生存チェックを挟み、操作対象を安定化する。

5. ログイン成功判定を段階化
- `/user/{id}/...` 到達を最優先成功条件にする。
- 未ログインヘッダー（ログインボタン表示）を明示的に失敗条件にする。

6. ログイン後のID確定を保守的にする
- `user_id_confirmed` を導入して、確定IDがある場合は不要な再解決を避ける。
- 取得不能時のみ `/mypage/` で補完する。

## 3. 他サービス向け再利用チェックリスト

1. OAuth開始は必ず「サービス提供UIの正規導線」を最優先にする。
2. `state` は「取得して使う」。原則として「生成して押し込まない」。
3. `/done` 系中間ページは、ボタンクリックベースで復帰する。
4. コールバックURLの生値 (`href`) と最終遷移URLを両方ログに残す。
5. 失敗アラートは例外扱いではなく「状態遷移イベント」として処理する。
6. 成功判定はURL・UI・セッションの複合条件で行う。
7. 識別子抽出（user_id など）はノイズの多い全ページ走査を避け、文脈の強い要素を優先する。

## 4. 最低限残すべきデバッグログ

- OAuth開始前:
  - 選択した導線URL
- 認可中:
  - `current_url`
  - 取得した `state`
- `/authorize/done`:
  - 戻るリンクの実 `href`
  - 補正後URL
  - クリック方法（通常/JS）
- 復帰後:
  - 最終URL
  - 未ログインUI判定結果
  - 抽出 `user_id`

## 5. アンチパターン

- 固定の認可URLを優先し続ける実装。
- `state` 欠落を許容したまま callback を叩く実装。
- アラート発生時に即失敗終了し、状態確認を行わない実装。
- ログイン後にトップページ全リンクからユーザー識別子を拾う実装。
