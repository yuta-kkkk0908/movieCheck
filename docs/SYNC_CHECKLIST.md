# 同期ワークフロー 手動チェックリスト

最終更新: 2026-02-26  
対象: `POST /api/search/sync` を使う映画.com同期

## 0. 事前準備

- バックエンド起動: `bash scripts/dev-backend.sh`（環境により `python3 backend/main.py`）
- フロント起動: `bash scripts/dev-frontend.sh`
- 画面表示: 同期モーダルを開ける状態
- DBバックアップ（任意）:
  - `cp backend/instance/movies.db backend/instance/movies.db.bak.$(date +%Y%m%d%H%M%S)`

## 1. 初回同期（対話ログイン）

手順:
1. 同期モーダルで資格情報未入力のまま同期開始。
2. ブラウザで映画.comにログイン。
3. 同期完了メッセージを確認。

期待結果:
- `success=true`
- `added` が 1 以上（テストデータ次第）
- 記録一覧に作品/記録が追加される
- 監督・公開年が極端に欠損しない（取得できる範囲で反映）

## 2. 再同期（重複防止）

手順:
1. 直後に同じアカウントで再同期を実行。

期待結果:
- 既存データが二重登録されない
- `existing` が増え、`added` は初回より小さいか 0
- 記録件数が不自然に増えない

## 3. 保存済み資格情報ログイン

手順:
1. 同期モーダルで `email/password` を入力し、`保存して次回自動ログイン` を ON にして同期。
2. 同期モーダルを再度開き、資格情報表示（マスク）を確認。
3. 次回同期を `use_saved_credentials=true` で実行（入力を空にする）。

期待結果:
- 資格情報は平文表示されない
- 保存済み資格情報で同期できる
- `last_sync` が更新される

## 4. 保存OFF時の更新抑止

手順:
1. 既存の保存資格情報がある状態で、別の `email/password` を入力するが保存チェックを OFF にして同期。
2. 同期後、保存済み資格情報表示を確認。

期待結果:
- 保存済み資格情報は書き換わらない
- 明示入力の同期は実行される

## 5. 削除とフォールバック

手順:
1. 同期モーダルから保存済み資格情報を削除。
2. 入力なしで同期開始。

期待結果:
- 自動ログインは使われない（対話ログインへ）
- 削除後に `GET /api/credentials/eiga` で `has_credentials=false`

## 6. 途中失敗（ブラウザクローズ）

手順:
1. 対話ログイン同期を開始し、ログイン途中または同期途中でブラウザを閉じる。

期待結果:
- API応答が `success=false` かつ `cancelled=true`
- DBに中途半端なデータが残らない（rollback）

## 7. 復帰確認

手順:
1. 失敗直後に再度同期を実行。

期待結果:
- 通常どおり同期が完走する
- 前回失敗の影響で二重登録や例外連鎖が起きない

## 8. 収集すべき確認ログ

- API応答:
  - `success`, `cancelled`, `added`, `existing`, `errors`, `can_fallback_to_interactive`
- 画面:
  - 同期完了/失敗メッセージ
  - 記録一覧件数
- DB（任意）:
  - `movies` / `records` 件数差分
  - `eiga_credentials` の `is_active`, `last_sync`

## 9. 判定基準（完了）

- 初回/再同期/重複防止/中断/復帰の各シナリオが再現できる
- 期待結果と実測結果が一致する
- 不一致がある場合、再現手順とログを残せる
